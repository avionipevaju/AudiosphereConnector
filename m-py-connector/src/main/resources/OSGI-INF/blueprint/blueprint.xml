<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0
    https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
    http://camel.apache.org/schema/blueprint
    http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

    <!-- Configuration File -->
    <cm:property-placeholder persistent-id="configuration" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="moodyPyExecuteEndpoint" value="def-value"/>
            <cm:property name="moodyPyPostContentEndpoint" value="def-value"/>
            <cm:property name="instaFeedGetPostEndpoint" value="def=value"/>
        </cm:default-properties>
    </cm:property-placeholder>

    <!-- netty http bootstrap configuration -->
    <bean id="configuration" class="org.apache.camel.component.netty4.http.NettySharedHttpServerBootstrapConfiguration">
        <property name="port" value="8888"/>
        <property name="host" value="0.0.0.0"/>
    </bean>

    <!-- the netty http server -->
    <bean id="httpServer" class="org.apache.camel.component.netty4.http.DefaultNettySharedHttpServer"
          init-method="start" destroy-method="stop">
        <property name="nettyServerBootstrapConfiguration" ref="configuration"/>
    </bean>

    <!-- export in the OSGi server registry so we can use it from the Camel application bundles-->
    <service ref="httpServer" interface="org.apache.camel.component.netty4.http.NettySharedHttpServer"/>

    <!-- Jackson Object Mapper -->
    <bean id="jacksonObjectMapper" class="com.fasterxml.jackson.databind.ObjectMapper"/>

    <!-- Jackson Xml Mapper -->
    <bean id="jacksonXmlMapper" class="com.fasterxml.jackson.dataformat.xml.XmlMapper"/>

    <!-- Processors -->
    <bean id="twitterRequestProcessor" class="org.avionipevaju.moody.py.connector.processor.twitter.TwitterRequestProcessor"/>
    <bean id="twitterResponseProcessor" class="org.avionipevaju.moody.py.connector.processor.twitter.TwitterResponseProcessor"/>
    <bean id="exceptionHandlingProcessor" class="org.avionipevaju.moody.py.connector.processor.exception.ExceptionHandlingProcessor"/>
    <bean id="httpOperationFailedExceptionProcessor" class="org.avionipevaju.moody.py.connector.processor.exception.HttpOperationFailedExceptionProcessor">
        <property name="objectMapper" ref="jacksonObjectMapper"/>
    </bean>
    <bean id="instagramSchedulerPreProcessor" class="org.avionipevaju.moody.py.connector.processor.instagram.InstagramSchedulerPreProcessor">
        <property name="endpoint" value="${instaFeedGetPostEndpoint}"/>
    </bean>
    <bean id="instagramSchedulerRequestProcessor" class="org.avionipevaju.moody.py.connector.processor.instagram.InstagramSchedulerRequestProcessor"/>

    <!-- Route Builders -->
    <bean id="twitterSchedulerRouteBuilder" class="org.avionipevaju.moody.py.connector.route.twitter.TwitterSchedulerRouteBuilder">
        <property name="exceptionHandlingProcessor" ref="exceptionHandlingProcessor"/>
        <property name="httpOperationFailedExceptionProcessor" ref="httpOperationFailedExceptionProcessor"/>
        <property name="endpoint" value="${moodyPyExecuteEndpoint}"/>
    </bean>
    <bean id="instagramSchedulerRouteBuilder" class="org.avionipevaju.moody.py.connector.route.instagram.InstagramSchedulerRouteBuilder">
        <property name="exceptionHandlingProcessor" ref="exceptionHandlingProcessor"/>
        <property name="httpOperationFailedExceptionProcessor" ref="httpOperationFailedExceptionProcessor"/>
        <property name="instagramSchedulerPreProcessor" ref="instagramSchedulerPreProcessor"/>
        <property name="requestProcessor" ref="instagramSchedulerRequestProcessor"/>
    </bean>
    <bean id="twitterRouteBuilder" class="org.avionipevaju.moody.py.connector.route.twitter.TwitterRouteBuilder">
        <property name="requestProcessor" ref="twitterRequestProcessor"/>
        <property name="responseProcessor" ref="twitterResponseProcessor"/>
        <property name="exceptionHandlingProcessor" ref="exceptionHandlingProcessor"/>
        <property name="httpOperationFailedExceptionProcessor" ref="httpOperationFailedExceptionProcessor"/>
        <property name="endpoint" value="${moodyPyPostContentEndpoint}"/>
    </bean>

    <!-- Camel Context -->
    <camelContext id="m-py-context" xmlns="http://camel.apache.org/schema/blueprint">
        <routeBuilder ref="twitterSchedulerRouteBuilder"/>
        <routeBuilder ref="instagramSchedulerRouteBuilder"/>
        <routeBuilder ref="twitterRouteBuilder"/>

        <restConfiguration component="netty4-http" bindingMode="auto" contextPath="/m-py/api">
            <endpointProperty key="nettySharedHttpServer" value="#httpServer" />
        </restConfiguration>
    </camelContext>
</blueprint>