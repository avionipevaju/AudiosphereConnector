<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0
    https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
    http://camel.apache.org/schema/blueprint
    http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

    <!-- Configuration File -->
    <cm:property-placeholder persistent-id="configuration" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="moodyPyExecuteEndpoint" value="def-value"/>
        </cm:default-properties>
    </cm:property-placeholder>

    <!-- netty http bootstrap configuration -->
    <bean id="configuration" class="org.apache.camel.component.netty4.http.NettySharedHttpServerBootstrapConfiguration">
        <property name="port" value="8888"/>
        <property name="host" value="0.0.0.0"/>
    </bean>

    <!-- the netty http server -->
    <bean id="httpServer" class="org.apache.camel.component.netty4.http.DefaultNettySharedHttpServer"
          init-method="start" destroy-method="stop">
        <property name="nettyServerBootstrapConfiguration" ref="configuration"/>
    </bean>

    <!-- export in the OSGi server registry so we can use it from the Camel application bundles-->
    <service ref="httpServer" interface="org.apache.camel.component.netty4.http.NettySharedHttpServer"/>

    <!-- Jackson Object Mapper -->
    <bean id="jacksonObjectMapper" class="com.fasterxml.jackson.databind.ObjectMapper"/>

    <!-- Processors -->
    <bean id="requestProcessor" class="org.avionipevaju.moody.py.connector.processor.RequestProcessor"/>
    <bean id="responseProcessor" class="org.avionipevaju.moody.py.connector.processor.ResponseProcessor"/>
    <bean id="exceptionHandlingProcessor" class="org.avionipevaju.moody.py.connector.processor.ExceptionHandlingProcessor"/>

    <!-- Route Builders -->
    <bean id="schedulerRouteBuilder" class="org.avionipevaju.moody.py.connector.route.SchedulerRouteBuilder">
        <property name="requestProcessor" ref="requestProcessor"/>
        <property name="responseProcessor" ref="responseProcessor"/>
        <property name="exceptionHandlingProcessor" ref="exceptionHandlingProcessor"/>
        <property name="endpoint" value="${moodyPyExecuteEndpoint}"/>
    </bean>

    <!-- Camel Context -->
    <camelContext id="m-py-context" xmlns="http://camel.apache.org/schema/blueprint">
        <routeBuilder ref="schedulerRouteBuilder"/>

        <restConfiguration component="netty4-http" bindingMode="auto" contextPath="/m-py/api">
            <endpointProperty key="nettySharedHttpServer" value="#httpServer" />
        </restConfiguration>
    </camelContext>
</blueprint>